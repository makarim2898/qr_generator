<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">QR Code Generator</h1>

  <!-- Input manual -->
  <div class="mb-4">
    <form id="qrForm" class="row g-2">
      <div class="col-md-8">
        <input type="text" id="dataInput" class="form-control" placeholder="Masukkan data..." required />
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary w-100">Generate Manual</button>
      </div>
    </form>
    <div class="mt-3" id="qrResult" style="display: none;">
      <canvas id="qrCanvas" class="border p-2 bg-white"></canvas>
      <br />
      <a id="downloadSingle" class="btn btn-success mt-2" download="qr.png">Download</a>
    </div>
  </div>

  <!-- CSV upload -->
  <div class="mb-5">
    <label for="csvFile" class="form-label">Upload CSV (1 kolom data):</label>
    <input type="file" id="csvFile" accept=".csv" class="form-control mb-2" />
    <button class="btn btn-secondary" id="generateBatch">Generate & Download All</button>
    <div id="batchStatus" class="form-text mt-2"></div>
  </div>
</div>

<script>
  // QR dari input manual
  const form = document.getElementById('qrForm');
  const input = document.getElementById('dataInput');
  const canvas = document.getElementById('qrCanvas');
  const result = document.getElementById('qrResult');
  const downloadSingle = document.getElementById('downloadSingle');

  function generateQR(data, canvasTarget) {
    return QRCode.toCanvas(canvasTarget, data, { width: 256 });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = input.value.trim();
    if (data) {
      await generateQR(data, canvas);
      downloadSingle.href = canvas.toDataURL("image/png");
      result.style.display = 'block';
    }
  });

  // QR dari query string
  const urlParams = new URLSearchParams(window.location.search);
  const prefillData = urlParams.get('data');
  if (prefillData) {
    // Generate langsung QR dalam bentuk image PNG
    QRCode.toDataURL(prefillData, { width: 256 }, function(err, url) {
      if (!err) {
        const img = new Image();
        img.src = url;
        document.body.innerHTML = ""; // kosongkan isi page
        document.body.appendChild(img);
      }
    });
  }

  // QR dari CSV
  document.getElementById('generateBatch').addEventListener('click', async () => {
    const file = document.getElementById('csvFile').files[0];
    if (!file) return alert("Pilih file CSV dulu");

    const reader = new FileReader();
    reader.onload = async function (e) {
      const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
      const zip = new JSZip();
      const canvasTemp = document.createElement('canvas');
      const ctx = canvasTemp.getContext('2d');

      for (let i = 0; i < lines.length; i++) {
        const data = lines[i].trim();
        await QRCode.toCanvas(canvasTemp, data, { width: 256 });
        const imgData = canvasTemp.toDataURL("image/png");
        const imgBlob = await (await fetch(imgData)).blob();
        zip.file(`qr_${i + 1}.png`, imgBlob);
      }

      zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, "qr_batch.zip");
        document.getElementById('batchStatus').textContent = `${lines.length} QR berhasil dibuat.`;
      });
    };

    reader.readAsText(file);
  });
</script>
</body>
</html>
